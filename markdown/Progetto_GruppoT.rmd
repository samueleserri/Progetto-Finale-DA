---
title: "Progetto dataset oliveoil - Gruppo T"
output: word_document
date: "2024-06-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Abbiamo analizzato il dataset oliveoil contenuto nel pacchetto pdfCluster.
Contenete dati relativi alla composizione chimica di diversi oli d'oliva provenienti da diverse macro aree e regioni Italiane.


### Librerie necessarie
```{r results = 'hide'}
library(cluster)
library(ggplot2)
library(ggcorrplot)
library(pdfCluster)
library(dbscan)
library(maps)
library(moments)
library(compositions)
library(reshape2)
```


### Funzioni usate nel progetto
```{r}
# Funzione per le Variabili Quantitative
display_summary_and_var <- function(variabile){
  c(summary(variabile), 
  var = var(variabile, na.rm = T), 
  sd = sd(variabile, na.rm = T),
  sk = skewness(variabile, na.rm = T))
}

# Funzione per le Variabili Qualitative
display_table <- function(variabile, titolo){
  DistAs <- table(variabile)
  DistRe <- prop.table(table(variabile))
  barplot(prop.table(table(variabile)), main = titolo)
  print(rbind(DistAs, DistRe))
}
```


## Import del dataset e pulizia dei dati

Si decide di normalizzare i dati nel seguente modo:
$$ y_{ij}=\frac{x_{ij}+1}{\sum_{j=3}^{10} (x_{ij}+1)}  \;\;\;\;,\; \forall j \; \text{ colonna} , \forall i \; \text{ riga}$$

Questo perché i dati sono di natura compositiva, infatti ogni riga somma circa a 10000 e  quindi possono essere visti come la percentuale di un particolare acido nell'olio
Dalla formula si nota che ad ogni osservazione è stato sommato 1 perché nei dati originali ci sono degli zeri dovuti alle misurazioni al di sotto del livello di sensibilità degli strumenti con la quale è stata effettuata l'analisi

```{r}
data("oliveoil")
str(oliveoil)

oliveoil[,3:10] <- oliveoil[,3:10]+1
for (i in 1:nrow(oliveoil)){
  oliveoil[i,3:10] <- oliveoil[i,3:10]/sum(oliveoil[i,3:10])
}
```


## Anilisi univariata e bivariata del dataset


### Variabile Macro Area
```{r}
display_table(oliveoil$macro.area, "Macro Area")
```

### Variabile Regioni
```{r}
display_table(oliveoil$region, "Regioni")
```



### Variabile acido palmitic

È un acido grasso saturo con 16 atomi di carbonio. È uno degli acidi grassi più comuni presenti negli oli vegetali e negli animali. È solido a temperatura ambiente e contribuisce alla consistenza degli oli.

```{r}
display_summary_and_var(oliveoil$palmitic)
hist(oliveoil$palmitic, probability = T,col = 5, main = "palmitic")
boxplot(oliveoil$palmitic~oliveoil$macro.area)
boxplot(oliveoil$palmitic~oliveoil$region)
```

Istogramma: La distribuzione è leggermente asimmetrica a destra con la maggior parte dei valori compresi tra 0.10 e 0.16.
Boxplot (Area Macro): La regione Sud ha un valore mediano più alto rispetto a Sardegna e Centro-Nord.
Boxplot (Regione): I valori mediani più alti si trovano in Puglia Nord e Sicilia, con una significativa variabilità e outlier, indicando una gamma diversificata di composizioni.




### Variabile acido palmitoleic

È un acido grasso monoinsaturo con 16 atomi di carbonio e un doppio legame nella posizione 9. Si trova principalmente negli oli di pesce e in alcune piante. Ha proprietà emollienti e antiossidanti.

```{r}
display_summary_and_var(oliveoil$palmitoleic)
hist(oliveoil$palmitoleic,col = 5, main = "palmitoleic")
boxplot(oliveoil$palmitoleic~oliveoil$macro.area)
boxplot(oliveoil$palmitoleic~oliveoil$region)
```

Istogramma: La distribuzione è leggermente asimmetrica a destra con un picco intorno a 0.015.
Boxplot (Area Macro): La regione Sud ha i valori mediani più alti, mentre Sardegna e Centro-Nord hanno valori più bassi.
Boxplot (Regione): Puglia Nord e Sicilia mostrano valori mediani più alti, con una significativa variabilità e outlier, indicando una gamma diversificata di composizioni.



### Variabile acido stearic

È un acido grasso saturo con 18 atomi di carbonio. Comunemente presente nel burro di cacao e nel sego, viene utilizzato in cosmetica e nella produzione di candele per la sua consistenza solida a temperatura ambiente.

```{r}
display_summary_and_var(oliveoil$stearic)
hist(oliveoil$stearic, col = 5, main = "stearic")
boxplot(oliveoil$stearic~oliveoil$macro.area)
boxplot(oliveoil$stearic~oliveoil$region)
```

Istogramma: La distribuzione è leggermente asimmetrica a destra, con la maggior parte dei valori compresi tra 0.02 e 0.03.
Boxplot (Area Macro): La regione Sud ha un valore mediano più alto, mentre Sardegna e Centro-Nord hanno valori più bassi.
Boxplot (Regione): I valori mediani più alti si trovano in Puglia Nord e Sicilia. La variabilità è alta, con molti outlier in queste regioni.




### Variabile acido oleic

È un acido grasso monoinsaturo con 18 atomi di carbonio e un doppio legame nella posizione 9. È il principale componente dell'olio d'oliva e di molti altri oli vegetali, noto per le sue proprietà benefiche per la salute cardiovascolare.

```{r}
display_summary_and_var(oliveoil$oleic)
hist(oliveoil$oleic, col = 5, main = "oleic")
boxplot(oliveoil$oleic~oliveoil$macro.area)
boxplot(oliveoil$oleic~oliveoil$region)
```

Istogramma: La distribuzione è approssimativamente normale, centrata intorno a 0.75.
Boxplot (Area Macro): La Sardegna mostra un valore mediano più alto rispetto al Sud e al Centro-Nord.
Boxplot (Regione): Puglia Nord, Sicilia e Liguria Est hanno valori mediani più alti, con la Sicilia che mostra la gamma più ampia e molti outlier, indicando una significativa variabilità nel contenuto di acido oleico in questa regione.




### Variabile acido linoleic

È un acido grasso polinsaturo con 18 atomi di carbonio e due doppi legami nelle posizioni 9 e 12. È essenziale per il corpo umano, che non può sintetizzarlo, e si trova in oli come quello di girasole e di mais. È importante per la salute della pelle e la funzione cellulare.

```{r}
display_summary_and_var(oliveoil$linoleic)
hist(oliveoil$linoleic, col = 5, main = "linoleic")
boxplot(oliveoil$linoleic~oliveoil$macro.area)
boxplot(oliveoil$linoleic~oliveoil$region)
```

Istogramma: La distribuzione è leggermente asimmetrica a destra, con un intervallo di valori compreso tra 0.04 e 0.14.
Boxplot (Area Macro): La regione Sud ha il valore mediano più alto, mentre Sardegna e Centro-Nord hanno valori mediani significativamente più bassi.
Boxplot (Regione): Puglia Nord, Sicilia e Liguria Est mostrano valori mediani più alti. La variabilità all'interno di queste regioni è alta, indicando composizioni dell'olio molto diverse.



### Variabile acido linolenic

È un acido grasso polinsaturo con 18 atomi di carbonio e tre doppi legami nelle posizioni 9, 12 e 15. È essenziale e si trova negli oli di semi di lino e di soia. Ha un ruolo cruciale nella funzione cerebrale e nella crescita normale.

```{r}
display_summary_and_var(oliveoil$linolenic)
hist(oliveoil$linolenic, col = 5, main = "linolenic")
boxplot(oliveoil$linolenic~oliveoil$macro.area)
boxplot(oliveoil$linolenic~oliveoil$region)
```

Istogramma: La distribuzione è approssimativamente normale ma leggermente asimmetrica a destra. La maggior parte dei valori rientra tra 0.002 e 0.006.
Boxplot (Area Macro): La regione Sud mostra di nuovo valori mediani più alti. Centro-Nord e Sardegna mostrano valori più bassi, con la Sardegna che ha la mediana più bassa.
Boxplot (Regione): I valori mediani più alti si trovano in regioni come la Puglia Nord e la Sicilia. La variabilità in queste regioni è alta, con diversi outlier nella Liguria Est.





### Variabile acido arachidic

È un acido grasso saturo con 20 atomi di carbonio. Si trova in piccole quantità nell'olio di arachidi e nel burro di cacao. È solido a temperatura ambiente e viene utilizzato in alcuni processi industriali.

```{r}
display_summary_and_var(oliveoil$arachidic)
hist(oliveoil$arachidic, col = 5, main = "arachidic")
boxplot(oliveoil$arachidic~oliveoil$macro.area)
boxplot(oliveoil$arachidic~oliveoil$region)
```

Istogramma: La distribuzione è leggermente asimmetrica a destra con un picco intorno a 0.006. Questo suggerisce che la maggior parte dei campioni di olio d'oliva ha livelli moderati di acido arachidico.
Boxplot (Area Macro): La regione Sud mostra un valore mediano più alto, mentre Sardegna e Centro-Nord hanno valori mediani più bassi e simili.
Boxplot (Regione): Regioni come la Puglia Nord e la Sicilia hanno valori mediani più alti rispetto ad altre come la Liguria Est. Ci sono outlier nel Sud e nella Puglia Nord.



### Variabile acido eicosenoic

È un acido grasso monoinsaturo con 20 atomi di carbonio e un doppio legame nella posizione 11. È presente in piccole quantità negli oli vegetali e ha proprietà simili ad altri acidi grassi monoinsaturi, contribuendo alla fluidità delle membrane cellulari.

```{r}
display_summary_and_var(oliveoil$eicosenoic)
hist(oliveoil$eicosenoic, col = 5, main = "eicosenoic")
boxplot(oliveoil$eicosenoic~oliveoil$macro.area)
boxplot(oliveoil$eicosenoic~oliveoil$region)
```

Istogramma: La distribuzione dell'acido eicosenoico è fortemente asimmetrica a destra, con la maggior parte dei campioni che presentano una concentrazione molto bassa (vicina a 0.000). Questo indica che alte concentrazioni di acido eicosenoico sono rare.
Boxplot (Area Macro): Il boxplot mostra che la regione Sud ha una concentrazione mediana più alta rispetto alla Sardegna e al Centro-Nord, con queste ultime due che hanno valori molto bassi e simili.
Boxplot (Regione): Le regioni come la Puglia Nord e la Sicilia mostrano valori mediani più alti, mentre regioni come la Liguria Est hanno concentrazioni costantemente basse. Ci sono diversi outlier nel Sud e in Sicilia.




## Correlazione tra gli acidi

```{r}
ggcorrplot(cor(oliveoil[,3:9]), type = "lower", lab = TRUE)
```

Notiamio che le variabili con correlazione maggiore sono
-  palmitic palmitoleic
-  oleic palmitic
-  oleic palmitoleic
-  linoleic palmitoleic
-  linoleic oleic
-  arachidic linolenic
-  eicosenoic palmitic
-  eicosenoic linolenic

analizzeremo in seguito queste coppie di variabili nel dettaglio.



## Trasformazione dei dati

```{r}
oliveoil <- oliveoil[, -6]
```

xx


#### Dataset con le coordinate

Creazione del dataset contenete le coordinate GPS degli oli usato in seguito per i plot delle mappe

Si è deciso di sommare un offset alle coordinate dei punti di ogni regione, in modo da evitare che ogni singola osservazione venisse sovrapposta e per meglio mostrare visivamente la divisione in cluster di ogni regione.

```{r}

oliveGPS <- oliveoil[,1:2]
oliveGPS$lat <- NA
oliveGPS$long <- NA

region_coords <- list(
  "Apulia.north" = c(lat = 41.4, long = 15.5),
  "Calabria" = c(lat = 39.0, long = 16.5),
  "Apulia.south" = c(lat = 40.0, long = 18.0),
  "Sicily" = c(lat = 37.6, long = 14.1),
  "Sardinia.inland" = c(lat = 40.1, long = 9.0),
  "Sardinia.coast" = c(lat = 39.1, long = 9.7),
  "Liguria.east" = c(lat = 44.3, long = 9.5),
  "Liguria.west" = c(lat = 44.0, long = 8.0),
  "Umbria" = c(lat = 42.9, long = 12.6)
)

for (i in 1:nrow(oliveGPS)) {
  region <- oliveGPS$region[i]
  if (region %in% names(region_coords)) {
    oliveGPS$lat[i] <- region_coords[[region]]["lat"]
    oliveGPS$long[i] <- region_coords[[region]]["long"]
  }
}

for (i in 1:nrow(oliveGPS)) {
  oliveGPS$lat[i] <- oliveGPS$lat[i] + runif(1, min = -0.4, max = 0.4)
  oliveGPS$long[i] <- oliveGPS$long[i] + runif(1, min = -0.4, max = 0.4)
}

```




## Cluster Analysis

Abbiamo utilizzato quattro diversi algoritmi di clusterizzazione:
- k-means
- PAM
- DBSCAN
- pdfCluster


### K-Means

K-Means è un metodo di raggruppamento in cluster che misura le distanze dei punti di un cluster dal suo centro e cerca di minimizzarla.
L'algoritmo prende in input il dataset e il numero di cluster voluto e opera nel seguente modo:
1. si sceglie K punti casuali diversi dai punti del dataset che sono  i centroidi dei  cluster
2. si associa ogni dato al centroide più vicino
3. per ogni gruppo si trova il punto medio che diventerà il nuovo centroide di quel gruppo
4. itero dal punto 2 fino a quando nessun dato cambia gruppo tra un'iterazione e l'altra

L'algoritmo viene implementato in R attraverso la funzione kmeans()

Per la scelta del miglior K usiamo il metodo elbow:
Si prova a implementare k-means con diversi valori di K, e per ognuno si calcola la withinss, ovvero la somma dei quadrati delle distanze tra i punti e il centro del cluster a cui appartengono.
Quindi si fa il plot dei valori ottenuti e si sceglie il miglior compromesso tra una bassa withinss e un numero di cluster adeguato


```{r}
withins <- c(1:9)
for (i in 1:9){
  km.out <- kmeans(oliveoil[,3:9], centers = i, nstart = 15)
  withins[i] <- km.out$tot.withinss
}
plot(1:9, withins, pch=19, col = "blue")

# dal grafico si nota che il numero migliore di cluster è 3 o 4

# si procede con l'implementazione di kmeans con K=4
set.seed(17)
km.out <- kmeans(oliveoil[,3:9], centers=4, nstart = 15)
str(km.out)
```


Per meglio visualizzare i cluster abbiamo selezionato le coppie di acidi con correlazione maggiore.

```{r}
par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveoil$palmitic, oliveoil$palmitoleic, col = km.out$cluster, pch = 19)

# linoleic palmitoleic
plot(oliveoil$linoleic, oliveoil$palmitoleic, col = km.out$cluster, pch = 19)

# arachidic linolenic
plot(oliveoil$linolenic, oliveoil$arachidic, col = km.out$cluster, pch = 19)

# eicosenoic palmitic
plot(oliveoil$palmitic, oliveoil$eicosenoic, col = km.out$cluster, pch = 19)

# eicosenoic linolenic
plot(oliveoil$linolenic, oliveoil$eicosenoic, col = km.out$cluster, pch = 19)

par(mfrow=c(1,1))
```



#### Variabile `palmitic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = palmitic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `palmitoleic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = palmitoleic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `stearic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = stearic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `linoleic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = linoleic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `linolenic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = linolenic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `arachidic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = arachidic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `eicosenoic` nei cluster

```{r}
ggplot(oliveoil, aes(x = as.factor(km.out$cluster), y = eicosenoic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `macro.area` nei cluster

```{r}

prop.table(table(oliveoil$macro.area, km.out$cluster),1)

barplot(prop.table(table(oliveoil$macro.area, km.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4)
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, km.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveoil$macro.area, km.out$cluster),2), beside = T, legend = F, main = "", col = 2:4)
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, km.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")


```

xx


Questo si può vedere anche dalla Confuzion Matrix ovvero:

```{r}
confusion_matrix <- table(Cluster = oliveoil$macro.area, Aree = km.out$cluster)

table( Aree = km.out$cluster, Cluster = oliveoil$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Variabile `region` nei cluster

```{r}
prop.table(table(km.out$cluster, oliveoil$region),1)

barplot(prop.table(table(km.out$cluster, oliveoil$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:5, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(prop.table(table(km.out$cluster, oliveoil$region),1)
), fill = 2:5, cex = 0.8, bty = "n")

barplot(prop.table(table(km.out$cluster, oliveoil$region),2), beside = T, legend = F, main = "", col = 2:5, cex.names = 0.70, las=2)
legend("topright", legend = rownames(prop.table(table(km.out$cluster, oliveoil$region),1)
), fill = 2:5, cex = 0.8, bty = "n")

```


xx



Di seguito la confusion matrix:

```{r}
confusion_matrix <- table(Cluster = oliveoil$region, Regioni = km.out$cluster)

table(Regioni = km.out$cluster, Cluster = oliveoil$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Adjusted Rand Index - K Means

```{r}
ari_km <- adj.rand.index(oliveoil$macro.area, km.out$cluster)
ari_km
```



#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=km.out$cluster+1, pch=19, cex=0.3)
```





### PAM
L'algoritmo PAM prende in input una matrice di dati numerica, un intero k che corrisponde al numero di cluster e una metrica. PAM opera nel seguente modo:

1. Si selezionano k punti (medoidi) tra i punti presenti nel dataset e si associa ogni punto al medoide più vicino secondo la metrica selezionata.

2. Si selezionano in modo casuale nuovi medoidi

3. Si calcola la somma di tutte le distanze tra ogni punto e il medoide al quale è associato.Si assoccia ogni punto al nuovo medoide più vicino e si calcola la somma di tutte le distanze tra ogni punto e il nuovo medoide al quale è associato.

4. Se la nuova distanza è minore della vecchia allora si scambiano i medoidi

5. Sitera dal punto 2 fino a quando non ci sono cambiamenti nell'insieme di medoidi.



#### Distanze
La divisione in cluster dell'algoritmo PAM dipende dalla funzione di distanza che si decide di utilizzare. Due distanze utilizzate dall'algoritmo sono:

La distanza euclidea: 
$$
d_E(p,q) =\Big(\sum_{i = 1}^n (p_i - q_i)^2 \Big)^{\frac{1}{2}}
$$
La distanza di Manatthan:
$$
d_M(p,q) = \sum_{i = 1}^n |p_i - q_i|
$$

Si decide di testare l'algoritmo PAM con le due distanze e con diversi valori di K per scegliere i parametri che creano i cluster migliori.

```{r}
# DISTANZA MANHATTAN
larghezza_media_m <- c(1:9)
for (i in 2:10){
  pam.out<-pam(oliveoil[,3:9], i, metric="manhattan", stand=TRUE, nstart = 10)
  larghezza_media_m[i-1] <- pam.out$silinfo$avg.width
}

# DISTANZA EUCLIDEA
larghezza_media_e <- c(1:9)
for (i in 2:10){
  pam.out<-pam(oliveoil[,3:9], i, metric="euclidean", stand=TRUE, nstart = 10)
  larghezza_media_e[i-1] <- pam.out$silinfo$avg.width
}


plot(2:10, larghezza_media_m, col = "red", pch = 19)
points(2:10, larghezza_media_e, col = "blue", pch = 19)
legend("topright", legend = c("manhattan", "euclidean"), col = c("red", "blue"), pch =19)

```

Il numero di cluster migliore sembra essere 5.
La distanza manhattan è migliore della distanza euclidea a parità di numero di cluster, come si vede dal grafico.


```{r}
set.seed(17)
pam.out<-pam(oliveoil[,3:9], 5, metric="manhattan", stand=TRUE, nstart = 10)
str(pam.out)

# GRAFICO 
sil_df <- as.data.frame(silhouette(pam.out)[, 1:3])
colnames(sil_df) <- c("cluster", "neighbor", "sil_width")
sil_df$obs <- 1:nrow(sil_df)
sil_df <- sil_df[order(sil_df$cluster, -sil_df$sil_width),]
sil_df$obs_ordered <- factor(sil_df$obs, levels = sil_df$obs)

ggplot(sil_df, aes(x = obs_ordered, y = sil_width, fill = factor(cluster))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = rainbow(5)) +
  labs(title = "Silhouette Plot", x = "Observation", y = "Silhouette Width") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```



Per meglio visualizzare i cluster abbiamo selezionato le coppie di acidi con correlazione maggiore.

```{r}

par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveoil$palmitic, oliveoil$palmitoleic, col = pam.out$cluster, pch = 19)

# linoleic palmitoleic
plot(oliveoil$linoleic, oliveoil$palmitoleic, col = pam.out$cluster, pch = 19)

# arachidic linolenic
plot(oliveoil$linolenic, oliveoil$arachidic, col = pam.out$cluster, pch = 19)

# eicosenoic palmitic
plot(oliveoil$palmitic, oliveoil$eicosenoic, col = pam.out$cluster, pch = 19)

# eicosenoic linolenic
plot(oliveoil$linolenic, oliveoil$eicosenoic, col = pam.out$cluster, pch = 19)

par(mfrow=c(1,1))
```



#### Variabile `palmitic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = palmitic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `palmitoleic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = palmitoleic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `stearic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = stearic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `linoleic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = linoleic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `linolenic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = linolenic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `arachidic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = arachidic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `eicosenoic`

```{r}
ggplot(oliveoil, aes(x = as.factor(pam.out$cluster), y = eicosenoic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `macro.area`


```{r}
prop.table(table(oliveoil$macro.area, pam.out$cluster),1)

barplot(prop.table(table(oliveoil$macro.area, pam.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4, cex.names = 0.70) 
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, pam.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveoil$macro.area, pam.out$cluster),2), beside = T, legend = F, main = "", col = 2:4, cex.names = 0.70)
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, pam.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")

```

xx


Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveoil$macro.area, Aree = pam.out$cluster)

table( Aree = pam.out$cluster, Cluster = oliveoil$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


#### Variabile `region`

```{r}
prop.table(table(pam.out$cluster, oliveoil$region),1)

barplot(prop.table(table(pam.out$cluster, oliveoil$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:6, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(prop.table(table(pam.out$cluster, oliveoil$region),1)), fill = 2:6, cex = 0.8, bty = "n")


barplot(prop.table(table(pam.out$cluster, oliveoil$region),2), beside = T, legend = F, main = "", col = 2:6, cex.names = 0.70, las=2)
legend("topright", legend = rownames(prop.table(table(pam.out$cluster, oliveoil$region),1)), fill = 2:6, cex = 0.8, bty = "n")

```


xx


Confusion Matrix: 

```{r}
confusion_matrix <- table(Cluster = oliveoil$region, Regioni = pam.out$cluster)

table(Regioni = pam.out$cluster, Cluster = oliveoil$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Adjusted Rand Index - Pam

```{r}
ari_pam <- adj.rand.index(oliveoil$macro.area, pam.out$cluster)
ari_pam
```



#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=pam.out$cluster+1, pch=19, cex=0.3)
```




### DB SCAN

DBSCAN è un algoritmo di clustering basato sulla densità.
L'algoritmo prende in input una matrice numerica di dati, un numero ε e un intero Q.
Dove Q rappresenta il minimo numeo di punti neccessari a formare un cluster e ε rappresenta il raggio di un intorno.
L'algoritmo opera nel seguente modo:
1. Per ogni punto calcola gli intorni di raggio ε e identifica i centri che hanno un numero > Q di punti nel proprio interno.
2. Trova le componenti connesse dei centri dell'intorno.
3. Associa ogni punto a un cluster se dista < ε dal centro, i punti esclusi sono noise. 


Con kNNdistplot() otteniamo il grafico delle deistanze tra un ponto e il suo 17esimo punto più vicino.
Sceglaimo poi una distanza (raggio) con cui andremo poi a raggruppare i punti in cluster.


```{r}
kNNdistplot(oliveoil[,3:9], k = 17)
abline(h=0.0088, col = "red")
```

Il parametri miglior sono 0.013 come eps, e 18 come minPts


```{r}
set.seed(17)

db.out <- dbscan(oliveoil[,3:9], eps = 0.0088, minPts = 16)
str(db.out)
db.out
```

dbscan() ci diviede i dati in cluster, in questo caso 3 con 40 punti di "noise".


Per meglio visualizzare i cluster abbiamo selezionato le coppie di acidi con correlazione maggiore.

```{r}

par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveoil$palmitic, oliveoil$palmitoleic, col = db.out$cluster+1, pch = 19)

# linoleic palmitoleic
plot(oliveoil$linoleic, oliveoil$palmitoleic, col = db.out$cluster+1, pch = 19)

# arachidic linolenic
plot(oliveoil$linolenic, oliveoil$arachidic, col = db.out$cluster+1, pch = 19)

# eicosenoic palmitic
plot(oliveoil$palmitic, oliveoil$eicosenoic, col = db.out$cluster+1, pch = 19)

# eicosenoic linolenic
plot(oliveoil$linolenic, oliveoil$eicosenoic, col = db.out$cluster+1, pch = 19)

par(mfrow=c(1,1))
```




#### Variabile `palmitic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = palmitic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `palmitoleic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = palmitoleic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `stearic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = stearic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `linoleic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = linoleic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `linolenic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = linolenic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `arachidic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = arachidic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `eicosenoic`

```{r}
ggplot(oliveoil, aes(x = as.factor(db.out$cluster), y = eicosenoic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `macro.area`


```{r}
prop.table(table(db.out$cluster, oliveoil$macro.area),1)

barplot(prop.table(table(oliveoil$macro.area, db.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4, cex.names = 0.70) 
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, db.out$cluster),1)), fill = 2:4, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveoil$macro.area, db.out$cluster),2), beside = T, legend = F, main = "", col = 2:4, cex.names = 0.70)
legend("topright", legend = rownames(prop.table(table(oliveoil$macro.area, db.out$cluster),1)), fill = 2:4, cex = 0.8, bty = "n")

```

xx


Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveoil$macro.area, Aree = db.out$cluster)

table( Aree = db.out$cluster, Cluster = oliveoil$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Variabile `region`

```{r}
prop.table(table(db.out$cluster, oliveoil$region),1)
counts <- prop.table(table(db.out$cluster, oliveoil$region), 1)

barplot(prop.table(table(db.out$cluster, oliveoil$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:5, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(counts), fill = 2:5, cex = 0.8, bty = "n")

barplot(prop.table(table(db.out$cluster, oliveoil$region),2), beside = T, legend = F, main = "", col = 2:5, cex.names = 0.70, las=2)
legend("topright", legend = rownames(counts), fill = 2:5, cex = 0.8, bty = "n")

```


xx


```{r}
confusion_matrix <- table(Cluster = oliveoil$region, Regioni = db.out$cluster)

table(Regioni = db.out$cluster, Cluster = oliveoil$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


#### Adjusted Rand Index - DBSCAN

```{r}
ari_db <- adj.rand.index(oliveoil$macro.area, db.out$cluster)
ari_db
```



#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=db.out$cluster+1, pch=19, cex=0.3)
```



## Trasformazione ALR - Additive Log-Ratio Transofmation


A causa della natura compositiva dei dati, ovvero per il fatto che essi sommano a 10000 sulle righe, si decide di applicare una ulteriore trasformazione di tipo Additive Log-Ratio, in modo da rapportare tutte le colonne con una colonna fissata

Questa trasformazione consiste nel dividere ogni colonna del dataset per una colonna scelta arbitrariamente, e di applicare al risultato l'opposto del logatirmo: come nella seguente formula:


$$ y_{ij}= -log(\frac{x_{ij}}{x_{ik}}) \;\;\;\;,\; \forall j \not=k \; \text{ colonna}, \forall i \; \text{ riga} \text{, con k fissata}$$

La colonna k viene rimossa in quanto il rapporto $$\frac{x_{ij}}{x_{ik}} $$ è sempre 1 e di conseguenza si ottengono valori nulli una volta applicato il logaritmo

Quindi si è deciso di applicare la trasformazione alr al dataset oliveoil in modo da evidenziare eventuali differenze. 
Si sceglie la colonna 6 in modo da cercare di evidenziare cluster nei dati meno correlati. In quanto l'acido oleico è il più presente ed il più correlato con le altre variabili


#### re-import del dataset

```{r}
data("oliveoil")

oliveoil[,3:10] <- oliveoil[,3:10]+1
for (i in 1:nrow(oliveoil)){
  oliveoil[i,3:10] <- oliveoil[i,3:10]/sum(oliveoil[i,3:10])
}
```


```{r}
oliveALR <- -log(oliveoil[,-c(1,2,6)]/oliveoil[,6])
oliveALR <- cbind(oliveoil[,1:2], oliveALR)
```

Si vuole analizzare ora il dataset trasformato oliveALR

```{r}
ggcorrplot(cor(oliveALR[,3:9]), type = "lower", lab = TRUE)
```

Dal grafico si vede che le correlazioni ora sono  sempre positive, inoltre le variabili che erano fortemente correlate prima della trasformazione, rimangono fortemente correlate anche dopo la trasformazione logaritmica.

Altre informazioni degne di nota riguardano:




### K-means con ALR

Testiamo l'algoritmo con  dati trasformati tramite ALR.

Cerchiamo un buon numero di cluster con i dati trasformati usando il metodo elbow. In questo caso osserviamo che un buon numero per k è 4 oppure 5. Prima abbiamo trovato 3 o 4.

```{r}
# METODO DEL ELBOW
withins <- c(1:9)
for (i in 1:9){
  km.out <- kmeans(oliveALR[,3:9], centers = i, nstart = 15)
  withins[i] <- km.out$tot.withinss
}
par(mfrow=c(1,1))
plot(1:9, withins, pch = 19, col ="blue")
```

Si scieglie k = 4 e si usa la funzione kmeans()

```{r}
set.seed(17)
km.out <- kmeans(oliveALR[,3:9], centers=4, nstart = 15)
str(km.out)
```

Facciamo lo scatterplot di alcune variabili per visualizzare il cluster in particolare scegliamo degli acidi con una buona correlazione sulla base di quanto ottenuto dalla matrice di correlazione.

```{r}

par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveALR$palmitic, oliveALR$palmitoleic, col = km.out$cluster, pch = 19)

# linoleic palmitoleic
plot(oliveALR$linoleic, oliveALR$palmitic, col = km.out$cluster, pch = 19)

# linoleic palmitoleic
plot(oliveALR$palmitoleic, oliveALR$linoleic, col = km.out$cluster, pch = 19)

# arachidic linolenic
plot(oliveALR$linolenic, oliveALR$arachidic, col = km.out$cluster, pch = 19)

# eicosenoic palmitic
plot(oliveALR$palmitic, oliveALR$eicosenoic, col = km.out$cluster, pch = 19)

# eicosenoic palmitoleic
plot(oliveALR$palmitoleic, oliveALR$eicosenoic, col = km.out$cluster, pch = 19)

```

Si nota una buona divisione in cluster rispetto alle variabili palmitic e palmitoleic con un cluster identificato dal colore rosso per valori di concentrazione più bassi 


#### Variabile `palmitic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = palmitic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

La variabile palmitic presenta valori minori tra gli oli del secondo cluster, mentre negli altri gruppi la mediana dei valori è circa allineata


#### Variabile `palmitoleic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = palmitoleic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

Analogamente alla variabile palmitic, si nota un cluster 2 con una devianza within più elevata rispetto agli altri gruppi, che hanno anch'essi una mediana più alta.
Il cluster 1 e 3 sono abbastanza simili tra loro,
Il cluster 4 ha dei valori outlier più distanti dalle code della distribuzione.



#### Variabile `stearic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = stearic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

I cluster 1, 2 e 3 hanno delle mediane abbastanza simili tra loro, il che indica una bassa devianza between.
Il cluster 1 ha una devianza within più elevata ripetto agli altri.
Il cluster 4 ha dei valori di concentrazione più elevati


#### Variabile `linoleic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = linoleic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

Si nota che i cluster 2 e 3 hanno delle distribuzioni di acido linoleico simili, con una mediana più elevata rispetto agli altri cluster.
Il quarto cluster presenta la concentrazione più bassa di acido linoleico e anche dei valori outlier.



#### Variabile `linolenic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = linolenic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

Si nota una maggiore disparità tra i cluster rispetto agli altri acidi,
Il cluster 1 contiene tutti gli oli che hanno una quantità di acido linoleico uguale a zero, Il cluster 3 presenta alcuni valori outlier mentre il cluster 4 sembra avere una devianza within maggiore degli altri cluster


#### Variabile `arachidic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = arachidic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

La concentrazione di acido arachidico è distribuito tra i cluster in modo simile all'acido linolenico, si nota anche in questo caso che i valori più bassi di concentrazione sono contenuti nel cluster 1, e che il cluster 4 contiene una scala di valori di concentrazione più ampia


#### Variabile `eicosenoic` nei cluster

```{r}
ggplot(oliveALR, aes(x = as.factor(km.out$cluster), y = eicosenoic, fill = as.factor(km.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```

L'acido eicosenoico è contenuto in gran parte degli oli del cluster 2, mentre gli altri gruppi contengono tutti valori di concentrazione prossimi allo zero.



#### Variabile `macro.area`


```{r}
prop.table(table(oliveALR$macro.area, km.out$cluster),1)

barplot(prop.table(table(oliveALR$macro.area, km.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4, cex.names = 0.70) 
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, km.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveALR$macro.area, km.out$cluster),2), beside = T, legend = F, main = "", col = 2:4, cex.names = 0.70)
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, km.out$cluster),1)
), fill = 2:4, cex = 0.8, bty = "n")
```

Gli oli del Sud si trovano al 100% nel cluster 2
Gli oli della Sardegna al 99% nel cluster 3 e 1% nel cluster 4.
Gli oli del centro nord al 25% nel cluster 1, 23% nel cluster 3 e 52% nel cluster 4.

Il cluster 1 è composto al 100% da oli del centro nord.
Il cluster 2 al 100% da oli del sud.
Il cluster 3 al 73% da oli della Sardegna e al 27% da oli del centro nord.
Il cluster 4 al 99% da oli del centro nord e all'1% da oli della sardegna.

Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveALR$macro.area, Aree = km.out$cluster)

table( Aree = km.out$cluster, Cluster = oliveALR$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


#### Variabile `region`

```{r}
prop.table(table(km.out$cluster, oliveALR$region),1)

barplot(prop.table(table(km.out$cluster, oliveALR$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:5, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(prop.table(table(km.out$cluster, oliveALR$region),1)), fill = 2:5, cex = 0.8, bty = "n")


barplot(prop.table(table(km.out$cluster, oliveALR$region),2), beside = T, legend = F, main = "", col = 2:5, cex.names = 0.70, las=2)
legend("topright", legend = rownames(prop.table(table(km.out$cluster, oliveALR$region),1)), fill = 2:5, cex = 0.8, bty = "n")

```

Gli oli della puglia del nord si trovano al 100% nel cluster 2.
Gli oli della calabria si trovano al 100% nel cluster 2.
Gli oli della puglia del sud si trovano al 100% nel cluster 2.
Gli oli della Sicilia si trovano al 100% nel cluster 2.
Gli oli della Sardegna inland so trovano al 99% nel cluster 3 e 1% nel cluster 4.
Gli oli della Sardegna coast si trovano al 100% nel cluster 3.
Gli oli della liguria est si trovano al 64% nel cluster 3, al 30% nel cluster 4 e al 6% nel cluster 1.
Gli oli della liguria ovest si trovano al 68% nel cluster 1 e al 32% nel 4.
Gli oli dell'umbria si trovano al 94% nel cluster 4 e al 6% nel cluster 3.


Il cluster 1 è formato al 91% da oli della liguria ovest e al 9% da oli della liguria est.
Il cluster 2 è formato al 17% da oli della calabria, al 64% da oli della puglia sud, 8% da oli della puglia del nord e 11% da oli della Sicilia.
Il cluster 3 è formato al 48% da oli della Sardegna inland, al 25% da oli della Sardegna coast e al 24% da oli della liguria est, al 1% da oli dell'umbria.
Il cluster 4 contiene un 1% di oli della Sardegna inland, 19% di oli della liguria est, 20% liguria ovest e 60 % Umbria.


Confusion Matrix: 

```{r}
confusion_matrix <- table(Cluster = oliveALR$region, Regioni = km.out$cluster)

table(Regioni = km.out$cluster, Cluster = oliveALR$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Adjusted Rand Index - K Means

```{r}
ari_km_ln <- adj.rand.index(oliveALR$macro.area, km.out$cluster)
ari_km_ln
```


#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=km.out$cluster+1, pch=19, cex=0.3)
```


### PAM con ALR


Come visto prima, si testa l'algoritmo PAM con le due distanze e con diversi valori di K per scegliere i parametri che creano i cluster migliori.

```{r}
# DISTANZA MANHATTAN
larghezza_media_m <- c(1:9)
for (i in 2:10){
  pam.out<-pam(oliveALR[,3:9], i, metric="manhattan", stand=TRUE, nstart = 10)
  larghezza_media_m[i-1] <- pam.out$silinfo$avg.width
}

# DISTANZA EUCLIDEA
larghezza_media_e <- c(1:9)
for (i in 2:10){
  pam.out<-pam(oliveALR[,3:9], i, metric="euclidean", stand=TRUE, nstart = 10)
  larghezza_media_e[i-1] <- pam.out$silinfo$avg.width
}

plot(2:10, larghezza_media_m, col = "red", pch =19)
points(2:10, larghezza_media_e, col = "blue", pch =19)
legend("topright", legend = c("manhattan", "euclidean"), col = c("red", "blue"), pch =19)
```


Il numero di cluster migliore sembra essere 6
La distanza manhattan è nettamente migliore della distanza euclidea a parità di numero di cluster, come si vede dal grafico



```{r}
set.seed(17)
pam.out<-pam(oliveALR[,3:9], 6, metric="manhattan", stand=TRUE, nstart = 10)
str(pam.out)

# GRAFICO 
sil_df <- as.data.frame(silhouette(pam.out)[, 1:3])
colnames(sil_df) <- c("cluster", "neighbor", "sil_width")
sil_df$obs <- 1:nrow(sil_df)
sil_df <- sil_df[order(sil_df$cluster, -sil_df$sil_width),]
sil_df$obs_ordered <- factor(sil_df$obs, levels = sil_df$obs)

ggplot(sil_df, aes(x = obs_ordered, y = sil_width, fill = factor(cluster))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = rainbow(6)) +
  labs(title = "Silhouette Plot", x = "Observation", y = "Silhouette Width") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```



Per meglio visualizzare i cluster abbiamo selezionato le coppie di acidi con correlazione maggiore.

```{r}
par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveALR$palmitic, oliveALR$palmitoleic, col = pam.out$cluster, pch = 19)

# linoleic palmitoleic
plot(oliveALR$linoleic, oliveALR$palmitoleic, col = pam.out$cluster, pch = 19)

# linolenic arachidic
plot(oliveALR$linolenic, oliveALR$arachidic, col = pam.out$cluster, pch = 19)

# palmitic eicosenoic
plot(oliveALR$palmitic, oliveALR$eicosenoic, col = pam.out$cluster, pch = 19)

# linolenic eicosenoic
plot(oliveALR$linolenic, oliveALR$eicosenoic, col = pam.out$cluster, pch = 19)

par(mfrow=c(1,1))
```

In questo caso i grafici in cui si nota meglio la divisione in cluster sono linoleic-palmitoleic e palmitic-palmitoleic 



#### Variabile `palmitic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = palmitic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `palmitoleic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = palmitoleic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `stearic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = stearic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `linoleic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = linoleic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `linolenic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = linolenic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `arachidic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = arachidic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `eicosenoic`

```{r}
ggplot(oliveALR, aes(x = as.factor(pam.out$cluster), y = eicosenoic, fill = as.factor(pam.out$cluster))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `macro.area`


```{r}
prop.table(table(oliveALR$macro.area, pam.out$cluster),1)

barplot(prop.table(table(oliveALR$macro.area, pam.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4, cex.names = 0.70) 
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, pam.out$cluster),1)
), fill = 2:5, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveALR$macro.area, pam.out$cluster),2), beside = T, legend = F, main = "", col = 2:4, cex.names = 0.70)
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, pam.out$cluster),1)
), fill = 2:5, cex = 0.8, bty = "n")

```

Dai grafici si nota un netto miglioramento nel raggruppamento dei cluster di pam ALR ripetto agli altri algoritmi, se confrontati con i gruppi creati dalle macro areee.
Gli oli della sardegna vengono inseriti interamente nel cluster 4.
Gli oli del sud vengono inseriti per il 30% nel cluster 1 e 67% nel 3
Gli oli del centro nord invece non sono ben identificati e vengono smistati nei cluster 2, 4, 5 e 6

Per quanto riguarda i cluster invece, il primo e il terzo contegono oli provenienti quasi escusivamente dal sud
Il quinto e il sesto contengono escusivamente oli del centro nord


Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveALR$macro.area, Aree = pam.out$cluster)

table( Aree = pam.out$cluster, Cluster = oliveALR$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Variabile `region`

```{r}
prop.table(table(pam.out$cluster, oliveALR$region),1)

barplot(prop.table(table(pam.out$cluster, oliveALR$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:7, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(prop.table(table(pam.out$cluster, oliveALR$region),1)), fill = 2:7, cex = 0.8, bty = "n")


barplot(prop.table(table(pam.out$cluster, oliveALR$region),2), beside = T, legend = F, main = "", col = 2:7, cex.names = 0.70, las=2)
legend("topright", legend = rownames(prop.table(table(pam.out$cluster, oliveALR$region),1)), fill = 2:7, cex = 0.8, bty = "n")

```

Oltre alle precedenti osservazioni sulla macro area Sardegna (che sono ocnfermate dall'analisi riapetto alle regioni) si nota che:
Gli oli della puglia sud vengono inseriti interamente nel cluster 3
Gli oli dell'umbria vengono inseriti interamente nel custer 2, che non contiene oli provenienti da altre regioni
Gli oli della liguria est sono smistati in diversi cluster

Guardando i cluster invece possiamo affermare che il cluster 1 contiene oli della puglia nord, calabria e sicilia
il cluster 2 contiene oli della dell'umbria e in parte della puglia nord
il cluster 3 contiene oli della puglia sud, e in parte della sicilia
il cluster 4 contiene oli della sardegna e liguria est 
il cluster 5 e 6 contiene esclusivamente oli della liguria


Confusion Matrix: 

```{r}
confusion_matrix <- table(Cluster = oliveALR$region, Regioni = pam.out$cluster)

table(Regioni = pam.out$cluster, Cluster = oliveALR$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


#### Adjusted Rand Index - PAM

```{r}
ari_pam_ln <- adj.rand.index(oliveALR$macro.area, pam.out$cluster)
ari_pam_ln
```


#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=pam.out$cluster+1, pch=19, cex=0.3)
```



### DB SCAN con ALR


Come visto prima, si testa l'algoritmo DBSCAN attraverso la funzione kNNdistplot() e si analizza il grafico ottenuto.


```{r}
kNNdistplot(oliveALR[,3:9], k = 17)
abline(h=0.5, col = "red")
```

I parametri migliori trovati sono raggio 0.5 e punti minimi 18


```{r}
set.seed(17)

db.out <- dbscan(oliveALR[,3:9], eps = 0.5, minPts = 18)
str(db.out)
db.out
```

dbscan() ci diviede i dati in cluster, in questo caso 3 con 87 punti di "noise".


Per meglio visualizzare i cluster abbiamo selezionato le coppie di acidi con correlazione maggiore.

```{r}

par(mfrow=c(2,3))

# palmitic palmitoleic
plot(oliveALR$palmitic, oliveALR$palmitoleic, col = db.out$cluster+1, pch = 19)

# linoleic palmitoleic
plot(oliveALR$linoleic, oliveALR$palmitoleic, col = db.out$cluster+1, pch = 19)

# arachidic linolenic
plot(oliveALR$linolenic, oliveALR$arachidic, col = db.out$cluster+1, pch = 19)

# eicosenoic palmitic
plot(oliveALR$palmitic, oliveALR$eicosenoic, col = db.out$cluster+1, pch = 19)

# eicosenoic linolenic
plot(oliveALR$linolenic, oliveALR$eicosenoic, col = db.out$cluster+1, pch = 19)

par(mfrow=c(1,1))
```


#### Variabile `palmitic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = palmitic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `palmitoleic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = palmitoleic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `stearic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = stearic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `linoleic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = linoleic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```



#### Variabile `linolenic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = linolenic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `arachidic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = arachidic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `eicosenoic`

```{r}
ggplot(oliveALR, aes(x = as.factor(db.out$cluster), y = eicosenoic, fill = as.factor(db.out$cluster+1))) + geom_boxplot(width=0.7) + guides(fill = FALSE)
```




#### Variabile `macro.area`


```{r}
prop.table(table(db.out$cluster, oliveALR$macro.area),1)

barplot(prop.table(table(oliveALR$macro.area, db.out$cluster),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:4, cex.names = 0.70) 
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, db.out$cluster),1)), fill = 2:4, cex = 0.8, bty = "n")

barplot(prop.table(table(oliveALR$macro.area, db.out$cluster),2), beside = T, legend = F, main = "", col = 2:4, cex.names = 0.70)
legend("topright", legend = rownames(prop.table(table(oliveALR$macro.area, db.out$cluster),1)), fill = 2:4, cex = 0.8, bty = "n")

```

Si nota che i tre cluster contengono tutti prevalentemente un area geografica diversa:
- il cluster 1 contiene solo oli del Sud
- il cluster 2 è principalmente composto da oli della Sardegna
- il cluster 3 è formato da oli provenienti solamente dal Centro Nord
Gli oli del centro nord sono comunque distribuiti tra il cluster 2, 3 e sono anche presenti in gran parte nell'insieme sei punti di "noise"


Paragone con dati non trasformati:

Con la trasformazione logaritmica notiamo che gli oli del Sud e della Sardegna hanno una distribuzione migliore tra i cluster, infatti questi solo quasi esclusivamente appartenenti ad un singolo cluster ciascuno.
Per gli oli del Nord/Centro è invece accaduto il contrario, nella distribuzione in cluster senza trasformazione questi sono concentrati in un singolo cluster mentre con la trasformazione si dividono in 2 cluster con una gran parte di essi che sono considerati punti di "noise"


Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveALR$macro.area, Aree = db.out$cluster)

table( Aree = db.out$cluster, Cluster = oliveALR$macro.area)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Aree, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Aree", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Variabile `region`

```{r}
prop.table(table(db.out$cluster, oliveALR$region),1)
counts <- prop.table(table(db.out$cluster, oliveALR$region), 1)

barplot(prop.table(table(db.out$cluster, oliveALR$region),1), beside = T, legend = F, main = "Poporzione all'interno dei cluster", col = 2:5, cex.names = 0.70, las=2) 
legend("topright", legend = rownames(counts), fill = 2:5, cex = 0.8, bty = "n")

barplot(prop.table(table(db.out$cluster, oliveALR$region),2), beside = T, legend = F, main = "", col = 2:5, cex.names = 0.70, las=2)
legend("topright", legend = rownames(counts), fill = 2:5, cex = 0.8, bty = "n")

```


Notiamo che in questo caso, rimossi i valori di "noise", la distribuzione dei cluster tra le regioni è incredibilmente precisa:
 * Oli dalla Puglia, Calabria e Sicilia sono esclusivamente presenti nel cluster 1
 * Oli da Sardegna e Liguria dell'est sono quasi totalmente nel cluster 2
 * Infine, gli oli umbri sono tutti nel cluster 3
Notiamo però che gli oli provenienti dalla Liguria dell'ovest sono tutti considerati punti di "noise"


Paragone con dati non trasformati:

Si vede che il metodo con trasformazione logaritmica riesce a raggruppare con più precisone oli provenienti dalla stessa regione all'interno di un singolo cluster. 
I gruppi di regioni che andavano a raggrupparsi in un singolo cluster sono cambiati. Per esempio la Puglia del nord non è più nello stesso cluster con Liguria e Puglia ma adesso è situato le cluster con Calabria, Puglia del sud e Sicilia.
Infine, la distribuzione tra cluster degli oli provenienti dalla Liguria dell'ovest peggiora con la trasformazione. Tutti gli oli provenienti da quella regione sono infatti considerati punti di "noise" nel secondo caso.


Confusion Matrix:

```{r}
confusion_matrix <- table(Cluster = oliveALR$region, Regioni = db.out$cluster)

table(Regioni = db.out$cluster, Cluster = oliveALR$region)

ggplot(data = as.data.frame(as.table(confusion_matrix)), aes(x = Cluster, y = Regioni, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Regioni", y = "Cluster", fill = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Adjusted Rand Index - DB SCAN

```{r}
ari_db_ln <- adj.rand.index(oliveALR$macro.area, db.out$cluster)
ari_db_ln
```


#### Mappa dei cluster sulla cartina Italiana

```{r}
map("italy", col="white", fill=TRUE, lty=1, lwd=1, border="black")
points(oliveGPS$long, oliveGPS$lat, col=db.out$cluster+1, pch=19, cex=0.3)
```





